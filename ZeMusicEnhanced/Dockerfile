# ğŸµ ZeMusic Bot v3.0 - Enhanced Docker Configuration
# ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: 2025-01-28
# Ø§Ù„Ù†Ø³Ø®Ø©: 3.0.0 - Enhanced Edition

# ============================================
# Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
# ============================================

FROM python:3.11-slim-bookworm

# ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONIOENCODING=utf-8 \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    TZ=UTC \
    DEBIAN_FRONTEND=noninteractive

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø¬Ø°Ø± Ù„Ù„Ø£Ù…Ø§Ù†
RUN groupadd --gid 1000 zemusic && \
    useradd --uid 1000 --gid zemusic --shell /bin/bash --create-home zemusic

# ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    curl \
    wget \
    git \
    unzip \
    ca-certificates \
    # Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØµÙˆØª ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ
    ffmpeg \
    libavcodec-dev \
    libavformat-dev \
    libavutil-dev \
    libswscale-dev \
    libswresample-dev \
    # Ù…ÙƒØªØ¨Ø§Øª Python Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    python3-dev \
    python3-pip \
    build-essential \
    gcc \
    g++ \
    # Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†
    libssl-dev \
    libffi-dev \
    libxml2-dev \
    libxslt1-dev \
    # Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØµÙˆØ±
    libjpeg-dev \
    libpng-dev \
    libwebp-dev \
    # Ù…ÙƒØªØ¨Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    libsqlite3-dev \
    libpq-dev \
    # Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
    htop \
    neofetch \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /tmp/* \
    && rm -rf /var/tmp/*

# ØªØ±Ù‚ÙŠØ© pip ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
RUN pip install --no-cache-dir --upgrade \
    pip \
    setuptools \
    wheel

# ØªØ¹ÙŠÙŠÙ† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„
WORKDIR /app

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ (Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Docker cache)
COPY requirements.txt .

# ØªØ«Ø¨ÙŠØª Ù…ØªØ·Ù„Ø¨Ø§Øª Python
RUN pip install --no-cache-dir --upgrade -r requirements.txt

# ============================================
# Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
# ============================================

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
COPY . .

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
RUN mkdir -p \
    logs \
    downloads \
    temp \
    sessions \
    backups \
    cookies \
    assets \
    && chown -R zemusic:zemusic /app

# ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
RUN chmod +x start.sh 2>/dev/null || echo "start.sh not found, skipping..."

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø§Ù„Ø¬Ø°Ø±
USER zemusic

# ============================================
# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
# ============================================

# ÙØ­Øµ ØµØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health', timeout=5)" || exit 1

# ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ÙƒØ´ÙˆÙØ©
EXPOSE 8000

# Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
ENV LOG_LEVEL=INFO \
    HIGH_LOAD_MODE=True \
    AUTO_BACKUP=True \
    ENABLE_DATABASE_CACHE=True

# Ù…Ù„ØµÙ‚Ø§Øª Docker
LABEL maintainer="ZeMusic Team" \
      version="3.0.0" \
      description="ZeMusic Bot Enhanced - High Performance Telegram Music Bot" \
      org.opencontainers.image.title="ZeMusic Bot Enhanced" \
      org.opencontainers.image.description="Advanced Telegram Music Bot with Telethon" \
      org.opencontainers.image.version="3.0.0" \
      org.opencontainers.image.created="2025-01-28" \
      org.opencontainers.image.source="https://github.com/your-username/ZeMusic-Enhanced" \
      org.opencontainers.image.licenses="MIT"

# ============================================
# Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„
# ============================================

# Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
CMD ["python", "-m", "ZeMusicEnhanced"]

# Ø£Ù…Ø± Ø¨Ø¯ÙŠÙ„ Ù„Ù„ØªØ·ÙˆÙŠØ±
# CMD ["python", "-m", "ZeMusicEnhanced", "--debug"]